import proguard.gradle.ProGuardTask

plugins {
	id 'checkstyle'
	id 'java-library'
	id 'java-test-fixtures'
}

dependencies {
	implementation libs.bundles.asm

	implementation libs.vineflower
	implementation libs.cfr
	implementation libs.procyon

	implementation libs.quilt.config

	testImplementation libs.jimfs

	testFixturesImplementation libs.asm
	testFixturesImplementation libs.asm.tree
}

// Generate "version.properties" file

final GEN_OUTPUT = project.layout.buildDirectory.dir('generated-resources')

tasks.register('generateVersionFile') {
	final outputFile = GEN_OUTPUT.map { it.file('version.properties') }

	inputs.property("version", project.version)
	inputs.property("vineflower-version", libs.vineflower.get().versionConstraint.displayName)
	inputs.property("cfr-version", libs.cfr.get().versionConstraint.displayName)
	inputs.property("procyon-version", libs.procyon.get().versionConstraint.displayName)

	outputs.file(outputFile)
	doLast {
		outputFile.get().asFile.text = inputs.properties.entrySet()
				.collect { "$it.key = $it.value" }.join("\n")
	}
}

sourceSets.main.output.dir GEN_OUTPUT, builtBy: generateVersionFile

static String taskNameFrom(String name) {
	final length = name.length()

	if (length == 0) {
		throw new IllegalArgumentException("name must not be empty!")
	}

	final builder = new StringBuilder()

	final first = name.charAt(0)

	final underscore = (char) '_'
	if (first != underscore) {
		builder.append(Character.toLowerCase(first))
	}

	for (int i = 1; i < length; i++) {
		final c = name.charAt(i)
		if (c == underscore) {
			if (i < length - 1) {
				builder.append(Character.toUpperCase(name.charAt(++i)))
			}
		} else {
			builder.append(Character.toLowerCase(c))
		}
	}

	return builder.toString()
}

// Generate obfuscated JARs for tests
// If your test fails for class file version problem with proguard, run gradle with -Dorg.gradle.java.home="<older jdk>" flag
def registerTestJarTasks(String name, String... input) {
	String taskName = taskNameFrom(name)
	final testJar = tasks.register("${taskName}TestJar", Jar.class) {
		group("test-setup")
		from(sourceSets.test.output) {
			include input
		}

		archiveFileName = "${name}.jar"
		destinationDirectory = file('build/test-inputs')
	}

	final customConfFile = file("src/test/resources/proguard-$name-test.conf")
	final confFileArg = customConfFile.exists() ? customConfFile
		: file('src/test/resources/proguard-test.conf')

	final testObf = tasks.register("${taskName}TestObf", ProGuardTask) {
		group("test-setup")

		configuration confFileArg

		libraryjars(
			[jarfilter: '!**.jar', filter: '!module-info.class'],
			"${System.getProperty('java.home')}/jmods/java.base.jmod"
		)

		injars testJar.map { it.archiveFile }

		outjars file("build/test-obf/${name}.jar")
	}

	test.dependsOn(testObf)
}

registerTestJarTasks("complete", "org/quiltmc/enigma/input/**/*.class")

file('src/test/java/org/quiltmc/enigma/input').listFiles().each { f ->
	if (f.directory) {
		registerTestJarTasks(f.name, "org/quiltmc/enigma/input/$f.name/**/*.class", "org/quiltmc/enigma/input/Keep.class")
	}
}

publishing {
	publications {
		"$project.name"(MavenPublication) {
			groupId project.group
			artifactId project.name
			version project.version
			from components.java
		}
	}
}
